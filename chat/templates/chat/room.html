<html>
    <head>
        <meta charset="utf-8">
        <title>
            Chat Room
        </title>
        <link rel="shortcut icon" href="/static/weibo/jquery-emoticons/public/image/favicon.png">
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
        <!-- <link rel="stylesheet" type="text/css" href="/static/weibo/jquery-emoticons/public/style/cssreset-min.css"> -->
        <!-- <link rel="stylesheet" type="text/css" href="/static/weibo/jquery-emoticons/public/style/common.css"> -->
        <style type="text/css">
          .file-close{
            margin-left: 5px;
          }
          .msg_file{
          }
          .fileDiv{
            background: #cecece;
            display: inline-block;
            width: auto;

          }
          .disabled input{
            display: none;
          }
          ul {
            list-style:none
          }
          .big_img {
            <!-- opacity : 0.9; -->
            <!-- width: 100%; -->
            <!-- height: 800px; -->
            margin:0 auto;
          }
          #img-close {
            width: 12px;
            position: fixed !important;
            top: 20%;
            left: 50%;
            margin-left: 240px;
            margin-top: -20px;
          }
          #msg_image{
            width: 500px;
            position: fixed !important;
            top: 20%;
            left: 50%;
            margin-left: -250px;
          }
        .emoticons{
        width: 525px;
        margin-bottom:20px;
        }
        .emoticons .publisher{
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px dotted #dbdbdb;
        }
        .emoticons .publisher textarea{
        width: 500px;
        height: 140px;
        padding: 5px 10px;
        border: 1px solid #dbdbdb;
        resize: none;
        }
        .trigger{
        font-size: 24px;
        font-weight: bold;
        color: #666;
        }
        .emoticons .publisher .trigger-active{
        color: #eb7350;
        }
        .emoticons .result{
        padding: 10px 15px;
        border: 1px dotted #dbdbdb;
        margin-top: 10px;
        height: 150px;
        line-height: 24px;
        }
        .emoticons .result img{
        vertical-align: middle;
        }

        .widget-layer{
        position: relative;
        width: 410px;
        margin-top: 8px;
        background: #fff;
        border: 1px solid #dbdbdb;
        border-radius: 2px;
        }
        .widget-layer:before{
        position: absolute;
        top: -16px;
        left: 2px;
        display: block;
        content: '';
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-bottom-color: #dbdbdb;
        }
        .widget-layer:after{
        position: absolute;
        top: -15px;
        left: 2px;
        display: block;
        content: '';
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-bottom-color: #f0f0f0;
        }
        .widget-layer .widget-tool{
        height: 28px;
        background: #f0f0f0;
        }
        .widget-layer .widget-close{
        float: right;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        font-family: Arial;
        }
        .widget-layer ul{
        width: 372px;
        margin: 0 auto;
        padding: 15px 5px 20px;
        overflow: hidden;
        }
        .widget-layer li{
        position: relative;
        z-index: 8;
        float: left;
        width: 25px;
        height: 25px;
        padding: 1px;
        margin-left: 5px;
        margin-top: 8px;
        border: 1px solid #e8e8e8;
        cursor: pointer;
        }
        .widget-layer li:hover{
        z-index: 9;
        border-color: #eb7350;
        }

            #chat-message-input {
              width: 580px;
              height: 150px;
              border: 1px solid #000;
              margin:10px auto 0;
            }
            #send {
              margin:10px auto 0;
              width: 580px;
              height: 50px;
            }
            #chat-file {
              margin:10px auto 0;
              width: 580px;
            }
            <!-- .chat_img{ -->
              <!-- [> width: 150px; <] -->
              <!-- height: 150px !important; -->
            <!-- } -->
            .msg_img{
              width: 100px;
            }

            .atalk{
              margin:10px; 
            }
            .atalk span{
              display:inline-block;
              background:#0181cc;
              border-radius:10px;
              color:#fff;
              padding:5px 10px;
            }
            .btalk{
              margin:10px;
              text-align:right;
            }
            .btalk span{
              display:inline-block;
              background:#ef8201;
              border-radius:10px;
              color:#fff;
              padding:5px 10px;
            }
            .talk_show{
              width:580px;
              height:320px;
              border:1px solid #666;
              background:#fff;
              margin:10px auto 0;
              overflow:auto;
            }

        </style>
    </head>
    <body>
        {% load staticfiles %} <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js" type="text/javascript">
</script><!-- chat -->
        <p>
            Your name: {{ username }} | <a href="/">Logout</a>
        </p><!-- <textarea id="chat-log" cols="100" rows="20"></textarea><br/> -->
        <div class="talk_show" id="words"></div>
        <div class="editor" contenteditable="true" id="chat-message-input">
            <!-- <input id="chat-message-input" type="text" size="100"/><br/> -->
        </div>
        <div class="disabled">
          <input type="file" id="upload-file" onchange=add_file(this.value)>
        </div>
        <div id="send">
            <span><a class="trigger" href="#">☺</a></span>
            <span><a class="upload-file" href="javascript:;"><span class="glyphicon glyphicon-paperclip">添加附件</span></a></span>
            <input style="float:right" id="chat-message-submit" type="button" value="Send">
            <div class="emoji"></div>
        </div>
        <div id="chat-file">
        </div>

        <script type="text/javascript">

        <!-- emoji -->
        var defaults = {
            'prefix':'widget',
            'publisherCls':'publisher',
            'triggerCls':'trigger',
            'activeCls':'active',
            'path':'/static/weibo/jquery-emoticons/public/image/',
            'list':[
                {'title':'微笑','url':'weixiao.gif'},
                {'title':'嘻嘻','url':'xixi.gif'},
                {'title':'哈哈','url':'haha.gif'},
                {'title':'可爱','url':'keai.gif'},
                {'title':'可怜','url':'kelian.gif'},
                {'title':'挖鼻','url':'wabi.gif'},
                {'title':'吃惊','url':'chijing.gif'},
                {'title':'害羞','url':'haixiu.gif'},
                {'title':'挤眼','url':'jiyan.gif'},
                {'title':'闭嘴','url':'bizui.gif'},
                {'title':'鄙视','url':'bishi.gif'},
                {'title':'爱你','url':'aini.gif'},
                {'title':'泪','url':'lei.gif'},
                {'title':'偷笑','url':'touxiao.gif'},
                {'title':'亲亲','url':'qinqin.gif'},
                {'title':'生病','url':'shengbing.gif'},
                {'title':'太开心','url':'taikaixin.gif'},
                {'title':'白眼','url':'baiyan.gif'},
                {'title':'右哼哼','url':'youhengheng.gif'},
                {'title':'左哼哼','url':'zuohengheng.gif'},
                {'title':'嘘','url':'xu.gif'},
                {'title':'衰','url':'shuai.gif'},
                {'title':'吐','url':'tu.gif'},
                {'title':'哈欠','url':'haqian.gif'},
                {'title':'抱抱','url':'baobao.gif'},
                {'title':'怒','url':'nu.gif'},
                {'title':'疑问','url':'yiwen.gif'},
                {'title':'馋嘴','url':'chanzui.gif'},
                {'title':'拜拜','url':'baibai.gif'},
                {'title':'思考','url':'sikao.gif'},
                {'title':'汗','url':'han.gif'},
                {'title':'困','url':'kun.gif'},
                {'title':'睡','url':'shui.gif'},
                {'title':'钱','url':'qian.gif'},
                {'title':'失望','url':'shiwang.gif'},
                {'title':'酷','url':'ku.gif'},
                {'title':'色','url':'se.gif'},
                {'title':'哼','url':'heng.gif'},
                {'title':'鼓掌','url':'guzhang.gif'},
                {'title':'晕','url':'yun.gif'},
                {'title':'悲伤','url':'beishang.gif'},
                {'title':'抓狂','url':'zhuakuang.gif'},
                {'title':'黑线','url':'heixian.gif'},
                {'title':'阴险','url':'yinxian.gif'},
                {'title':'怒骂','url':'numa.gif'},
                {'title':'互粉','url':'hufen.gif'},
                {'title':'书呆子','url':'shudaizi.gif'},
                {'title':'愤怒','url':'fennu.gif'},
                {'title':'感冒','url':'ganmao.gif'},
                {'title':'心','url':'xin.gif'},
                {'title':'伤心','url':'shangxin.gif'},
                {'title':'猪','url':'zhu.gif'},
                {'title':'熊猫','url':'xiongmao.gif'},
                {'title':'兔子','url':'tuzi.gif'},
                {'title':'OK','url':'ok.gif'},
                {'title':'耶','url':'ye.gif'},
                {'title':'GOOD','url':'good.gif'},
                {'title':'NO','url':'no.gif'},
                {'title':'赞','url':'zan.gif'},
                {'title':'来','url':'lai.gif'},
                {'title':'弱','url':'ruo.gif'},
                {'title':'草泥马','url':'caonima.gif'},
                {'title':'神马','url':'shenma.gif'},
                {'title':'囧','url':'jiong.gif'},
                {'title':'浮云','url':'fuyun.gif'},
                {'title':'给力','url':'geili.gif'},
                {'title':'围观','url':'weiguan.gif'},
                {'title':'威武','url':'weiwu.gif'},
                {'title':'话筒','url':'huatong.gif'},
                {'title':'蜡烛','url':'lazhu.gif'},
                {'title':'蛋糕','url':'dangao.gif'},
                {'title':'发红包','url':'fahongbao.gif'}
            ],
            'top':0,
            'left':0,
            'onShow':function(){},
            'onHide':function(){},
            'onSelect':function(){}
        };
        var options = $.extend({}, defaults);

        document.querySelector('.trigger').onclick = function(e) {
        <!-- 判断是否已经展开表情 -->
        if ($(".widget-panel").find("ul").length == 0){
        var ul = $("<ul>");
        for (i=0; i<options.list.length; i++) {
        var img = $("<img>");
        img.attr("src", options.path + options.list[i]["url"]);
        var li = $("<li>");
        li.attr("class", "emoji-img");
        li.attr("title", options.list[i]["title"]);
        li.bind("click", function(){
            var emoji_chat = "[/" + this.title + "]";
            $("#chat-message-input").append(emoji_chat);
            $(".widget-layer").remove();
            })
        li.append(img)
        ul.append(li)

        }
        var layer = $("<div>")
        var panel = $("<div>")
        var tool = $("<div>")
        var close_x = $("<a>")
        close_x.text("X")
        close_x.attr("class", "widget-close")
        close_x.attr("href", "javascript:;")
        close_x.attr("title", "关闭")
        close_x.bind("click", function(){
            $(".widget-layer").remove();
            })


        tool.append(close_x)
        tool.attr("class", "widget-tool")
        panel.append(ul)
        panel.attr("class", "widget-panel")
        layer.attr("class", "widget-layer")
        layer.append(tool)
        layer.append(panel)
        $(".emoji").append(layer)
        }else{
          $(".widget-layer").remove()
        }
        };
                      function convertBase64UrlToBlob(urlData){
                          var bytes=window.atob(urlData.split(',')[1]);        //去掉url的头，并转换为byte  
                          //处理异常,将ascii码小于0的转换为大于0
                          var ab = new ArrayBuffer(bytes.length);
                          var ia = new Uint8Array(ab);
                          for (var i = 0; i < bytes.length; i++) {
                                  ia[i] = bytes.charCodeAt(i);
                              }
                              return new Blob( [ab] , {type : 'image/png'});  
                      }

                        var roomMsg = {{ room_msg }};
                        var Words = document.getElementById("words");
                        for (var i = 0; i<roomMsg.length; i++){
                          roomMsg[i]["message"] = roomMsg[i]["msg"];
                          var chat_div = gen_chat_div(roomMsg[i]);
                          Words.innerHTML = Words.innerHTML + chat_div;
                        }
                        Words.scrollTop = Words.scrollHeight;
                        var roomName = {{ room_name }};

        var chatSocket = new WebSocket(
                'ws://' + window.location.host +
                '/ws/chat/' + roomName + '/' + "{{ username }}");

        chatSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                <!-- var message = data['message']; -->
                <!-- document.querySelector('#chat-log').value += (message + '\n'); -->
                var Words = document.getElementById("words");
                var chat_div = gen_chat_div(data);
                Words.innerHTML = Words.innerHTML + chat_div;
                Words.scrollTop = Words.scrollHeight;
            };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // enter, return
                            document.querySelector('#chat-message-submit').click();
                        }
            };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.innerText;
            if (message == "" && document.querySelector(".chat_img") && document.querySelector(".chat_img").length == 0){
              alert("message not null")
              return
            }
            <!-- upload file-->
            var form=document.forms[0];
            var formData = new FormData(form);
            var base64Codes_list = document.getElementsByClassName("chat_img");
            for (var i = 0; i<base64Codes_list.length; i++) {
              var base64Codes = base64Codes_list[i].src
              formData.append("file",convertBase64UrlToBlob(base64Codes));
              $.ajax({
                url:"/chat/upload",
                type:"POST",
                data: formData,
                dataType: "text",
                processData : false,
                contentType : false,
                success:function(data){
                var data = JSON.parse(data)

                  if (data["code"] == 0){
                    var data = data["data"]
                    var filePath = data["file_path"]
                    var message = "img:," + filePath
            chatSocket.send(JSON.stringify({
                              'message': "img:," + filePath
                                      }));
                  }else{
                    return
                  }
                }
              })
            }
            var file_list = document.getElementById("upload-file").files;
            console.log(file_list.length)
            for (var i=0; i<file_list.length; i++) {
              var formdata = new FormData();
              formdata.append("file", file_list[i]);
              var fileData = uploadFile(formdata)

              var filePath = fileData["file_path"]
              var fileName = fileData["file_name"]
              var message = "file:," + filePath + "," + fileName
              <!-- chatSocket.send(JSON.stringify({ -->
                          <!-- 'message': "file:," + filePath -->
                          <!-- })); -->

            }

            if (message){
            chatSocket.send(JSON.stringify({
                              'message': message
                                      }));}
            messageInputDom.innerText = '';
            $(".file-a").remove();
        };

        <!-- ##################################### -->
        window.onload = function () {
        function paste_img(e) {
        if (e.clipboardData.items) {
        var ele = e.clipboardData.items
        for (var i = 0; i < ele.length; ++i) {
          if (ele[i].kind == 'file' && ele[i].type.indexOf('image/') !== -1) {
            var blob = ele[i].getAsFile();
            window.URL = window.URL || window.webkitURL;
            var blobUrl = window.URL.createObjectURL(blob);
            var new_img = document.createElement('img');
            convertImgToBase64(blobUrl, function(base64Img){
            new_img.setAttribute('src', base64Img);
            new_img.setAttribute('class', "chat_img");
            new_img.setAttribute('height', "140px");
            document.getElementById('chat-message-input').appendChild(new_img);
          });
        }
        }
        } else {
        alert('您的浏览器不支持粘贴图片功能,请换更高版本浏览器.');
        }
        }
        document.getElementById('chat-message-input').onpaste = function () {
        paste_img(event);
        return false;
        };
        }
        function convertImgToBase64(url, callback, outputFormat){
        var canvas = document.createElement('CANVAS'),
        ctx = canvas.getContext('2d'),
        img = new Image;
        img.crossOrigin = 'Anonymous';
        img.onload = function(){
        canvas.height = img.height;
        canvas.width = img.width;
        ctx.drawImage(img,0,0);
        var dataURL = canvas.toDataURL(outputFormat || 'image/png');
        callback.call(this, dataURL);
        canvas = null;
        };
        img.src = url;
        }

        function handle_emoji(msg){
        chat_msg = "";
        for (var a=0; a<msg.length; a++){
        var msg_split = msg[a].split("]")
        if (msg_split.length == 1){
          var chat_msg = chat_msg + msg[a]
        }else{
          var null_count = 0;
          for (var j=0; j<msg_split.length; j++){
            <!-- 判断是否是表情 -->
            var emoji_chat_img = ""
            var is_emoji = 0;
            for (var k=0; k<options.list.length; k++) {
              if (options.list[k].title == msg_split[j]){
                var is_emoji = 1;
                var emoji_chat_img = "<img src='" + options.path + options.list[k]["url"] + "'>"
              }else{
              }
            }
            if (emoji_chat_img){
              var chat_msg = chat_msg + emoji_chat_img;
            }else{
              if (j != msg_split.length - 1){
                var chat_msg = chat_msg + msg_split[j] + "]";
              }
            }
          }
        }
        }
        return chat_msg
        }

        function gen_chat_div(data){
          var chat_div = document.createElement("div");
          chat_div.innerHTML = '<div><b>' + data["username"] + "<\/b> " + data["datetime"] + '</div>'
        if (data["message"].split(",")[0] == "img:"){
          // handle image
          chat_div.innerHTML = chat_div.innerHTML + '<div><img class="msg_img" src="' + data["message"].split(",")[1] + '">'
        }else if (data["message"].split(",")[0] == "file:"){
          // handle video
          var file_tag = '<a class="msg_file" href="' + data["message"].split(",")[1] + '" download="' + data["message"].split(",")[2] + '">';
          var file_ext = data["message"].split(",")[2].split(".")[1];
          var file_icon;
          if (file_ext == "jpg" || file_ext == "png"){
            var file_icon = "http://www.icosky.com/icon/ico/File%20Type/Crystal%20Project%20Mimetypes/image.ico"
          }else if(file_ext == "mp4" || file_ext == "avi"){
            var file_icon = "http://www.icosky.com/icon/ico/File%20Type/Crystal%20Project%20Mimetypes/video.ico"
          }else{
            var file_icon = "http://www.icosky.com/icon/ico/File%20Type/Crystal%20Project%20Mimetypes/info.ico"
          }
          file_tag = file_tag + '<div style="display: inline-block;"><img width="60px" src="' + file_icon + '">' + data["message"].split(",")[2] + '</div>'
          chat_div.innerHTML = chat_div.innerHTML + file_tag

        }else{
          // handle texts
          var msg = data["message"].split("[/");
          if (msg.length == 1){
            // handle text_all
            chat_div.innerHTML = chat_div.innerHTML + '<div><span>' + data["message"] +'</span>'
          }else{
            // handle have emoji texts
            chat_msg = handle_emoji(msg)
            chat_div.innerHTML = chat_div.innerHTML + '<div class="btalk"><span>' + chat_msg +'</span>'
          }
        }
        if (data["username"] == "{{ username }}"){
          chat_div.setAttribute("class", "btalk")
        }else{
          chat_div.setAttribute("class", "atalk")
        }
        var chatDiv = document.createElement("div");
        chatDiv.append(chat_div)
        return chatDiv.innerHTML
        }

        <!-- 图片放大 -->
        $("body").delegate(".msg_img", "click", function(){
            console.log("aaaa")
            var img_div = $("<div>");
            img_div.attr("class", "big_img");
            img_div.bind("click", function(){
                $(".big_img").remove();
                })
            var p = $("<p>")
            p.attr("id", "img-close")
            var p1 = $("<p>")
            var a = $("<a>")
            a.text("X")
            a.attr("href", "#")
            p.append(a)
            var img = $("<img>")
            img.attr("src", this.src)
            img.attr("id", "msg_image")
            p1.append(img)
            img_div.append(p)
            img_div.append(p1)
            $("body").append(img_div)
            })

        <!-- upload file -->
        document.querySelector('.upload-file').onclick = function(e) {
          document.querySelector('#upload-file').click()

        }

function add_file(e){
  var file_div = $("<div>")
  file_div.text(e)
  var file_close = $("<div>")
  <!-- file_close.text("X") -->
  file_close.attr("class", "file-close glyphicon glyphicon-remove")
  file_div.attr("class", "fileDiv")
  var tmp_div = $("<div>")
  tmp_div.attr("class", "file-a")
  tmp_div.append(file_div)
  tmp_div.append(file_close)
  $("#chat-file").append(tmp_div)
  <!-- ####,cc -->
  <!-- var formdata = new FormData(); -->
  <!-- formdata.append("file", $('.fileDiv')[0].files[0]); -->
}

function uploadFile(e) {
  var ret;
  $.ajax({
    url:"/chat/upload",
    type:"POST",
    data: e,
    dataType: "text",
    processData : false,
    contentType : false,
    async: false,
    success:function(data){
    var data = JSON.parse(data)

      if (data["code"] == 0){
        ret = data["data"]
      }else{
        return
      }
    }
  })
  return ret

}

$("body").delegate(".file-close", "click", function(){
  var obj = document.getElementById('upload-file');
  obj.outerHTML=obj.outerHTML;
  $(this).parent().remove()
    });


        </script>
    </body>
</html>
